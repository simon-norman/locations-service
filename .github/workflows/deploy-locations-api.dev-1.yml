name: Deploy Locations API to dev one

on: workflow_dispatch

permissions:
    id-token: write
    contents: read

jobs:
  deployment:
    runs-on: ubuntu-latest
    environment: dev-1
    steps:
      - run: echo "access_key_id"
      - run: echo ${{ secrets.AWS_ACCESS_KEY_ID }}
      - run: echo "access_key"
      - run: echo ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: Build
        uses: simon-norman/actions/build-cached@v1
        with:
          file: ./monorepo/applications/locations-api/Dockerfile
          tags: locations-api-dev-1:latest
          target: release
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-region: eu-west-2
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - uses: pulumi/actions@v3
        with:
          command: up
          stack-name: dev-1
          work-dir: infrastructure/locations-api
          refresh: true
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      # - uses: simon-norman/actions/deploy@v1
      #   name: Deploy
      #   with:
      #     env: dev-1
      #     file: ./monorepo/applications/locations-api/Dockerfile
      #     tag: locations-api-dev-1:latest
      #     aws_region: eu-west-2
      #     aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #   env:
      #     PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}